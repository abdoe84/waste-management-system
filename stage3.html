<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Prevent tracking prevention from blocking storage access -->
    <meta http-equiv="X-DNS-Prefetch-Control" content="on">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <title>Reviva - Stage 3 Data Entry</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script src="utils.js"></script>
    <style>
        :root {
            --primary: #3d9b7c;
            --secondary: #5fc1a8;
            --danger: #dc2626;
            --warning: #f59e0b;
            --success: #10b981;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #e8f5f0 0%, #d4ede3 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 24px 32px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: var(--primary);
            font-size: 28px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: #2d7a5f;
        }

        .btn-secondary {
            background: var(--gray-600);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--gray-700);
        }

        .form-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            padding: 32px;
            margin-bottom: 24px;
        }

        .request-info {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-label {
            color: var(--gray-600);
            font-weight: 500;
        }

        .info-value {
            color: var(--gray-800);
            font-weight: 600;
        }

        .section-title {
            color: var(--primary);
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .required::after {
            content: " *";
            color: var(--danger);
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(61, 155, 124, 0.1);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--primary);
        }

        .checkbox-item label {
            font-size: 14px;
            color: var(--gray-700);
            cursor: pointer;
        }

        .percent-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .percent-input {
            display: flex;
            flex-direction: column;
        }

        .percent-input input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .items-section {
            margin-top: 32px;
        }

        .item-card {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }

        .item-header {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .alert {
            padding: 14px 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-danger {
            background: #fee2e2;
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .alert-success {
            background: #d1fae5;
            color: var(--success);
            border-left: 4px solid var(--success);
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <img src="Logo.png" alt="Reviva Logo" style="max-width: 60px; height: auto;">
                <h1><i class="fas fa-clipboard-list"></i> Stage 3 Data Entry</h1>
            </div>
            <div style="display: flex; gap: 12px;">
                <button class="btn btn-secondary" onclick="window.location.href='review.html'">
                    <i class="fas fa-arrow-left"></i> Back to Reviews
                </button>
                <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                    <i class="fas fa-home"></i> Dashboard
                </button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <div class="form-card">
            <div id="requestInfo">
                <!-- Request info will be loaded here -->
            </div>

            <form id="stage3Form">
                <div id="itemsContainer">
                    <!-- Items with stage3 forms will be loaded here -->
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='review.html'">
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                        <i class="fas fa-paper-plane"></i> Submit for Manager Approval
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Initialize Supabase client with storage options to handle tracking prevention
        const supabaseClient = window.supabaseClient || (() => {
            try {
                if (typeof CONFIG !== 'undefined' && typeof supabase !== 'undefined') {
                    return supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY, {
                        auth: {
                            storage: typeof(Storage) !== 'undefined' ? window.localStorage : null,
                            autoRefreshToken: true,
                            persistSession: true,
                            detectSessionInUrl: true
                        },
                        global: {
                            headers: {
                                'X-Client-Info': 'ms-stage3'
                            }
                        }
                    });
                }
                const SUPABASE_URL = 'https://gcxvaclwugxdzwqbwtlx.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjeHZhY2x3dWd4ZHp3cWJ3dGx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU1NTQzNjYsImV4cCI6MjA4MTEzMDM2Nn0.jcRRo-oUjKp7pNvSzq8Rw7mJRk_htfN87VGG3j7TCBs';
                return supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                    auth: {
                        storage: typeof(Storage) !== 'undefined' ? window.localStorage : null,
                        autoRefreshToken: true,
                        persistSession: true,
                        detectSessionInUrl: true
                    },
                    global: {
                        headers: {
                            'X-Client-Info': 'ms-stage3'
                        }
                    }
                });
            } catch (error) {
                console.error('[Stage3] Error initializing Supabase client:', error);
                // Fallback: try without storage options
                if (typeof CONFIG !== 'undefined' && typeof supabase !== 'undefined') {
                    return supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
                }
                throw error;
            }
        })();

        const STAGE3_ATTACHMENTS_BUCKET = 'ms_attachments';

        // Upload Stage 3 attachments
        async function uploadStage3Attachments(formId, stage3DataId, itemId, files) {
            console.log(`[Stage3 Attachments] ========== Starting upload ==========`);
            console.log(`[Stage3 Attachments] Form ID: ${formId}`);
            console.log(`[Stage3 Attachments] Stage3 Data ID: ${stage3DataId}`);
            console.log(`[Stage3 Attachments] Item ID: ${itemId}`);
            console.log(`[Stage3 Attachments] Files count: ${files.length}`);
            console.log(`[Stage3 Attachments] Bucket: ${STAGE3_ATTACHMENTS_BUCKET}`);
            
            if (!files || files.length === 0) {
                console.log('[Stage3 Attachments] No files to upload');
                return { uploaded: 0, failed: 0 };
            }

            // Check if bucket exists (basic check)
            console.log(`[Stage3 Attachments] Checking bucket access...`);
            const { data: buckets, error: bucketError } = await supabaseClient.storage.listBuckets();
            if (bucketError) {
                console.error(`[Stage3 Attachments] Error checking buckets:`, bucketError);
            } else {
                const bucketExists = buckets?.some(b => b.name === STAGE3_ATTACHMENTS_BUCKET);
                console.log(`[Stage3 Attachments] Bucket exists: ${bucketExists}`);
                if (!bucketExists) {
                    console.error(`[Stage3 Attachments] ❌ Bucket '${STAGE3_ATTACHMENTS_BUCKET}' does not exist!`);
                    console.error(`[Stage3 Attachments] Please create the bucket in Supabase Storage first.`);
                }
            }

            let uploaded = 0;
            let failed = 0;
            const errors = [];

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                try {
                    console.log(`[Stage3 Attachments] ----- Processing file ${i + 1}/${files.length} -----`);
                    console.log(`[Stage3 Attachments] File name: ${file.name}`);
                    console.log(`[Stage3 Attachments] File size: ${(file.size / 1024).toFixed(2)} KB`);
                    console.log(`[Stage3 Attachments] File type: ${file.type || 'unknown'}`);
                    
                    const timestamp = Date.now();
                    const filePath = `stage3/form-${formId}/item-${itemId}/${timestamp}-${file.name}`;
                    console.log(`[Stage3 Attachments] Storage path: ${filePath}`);

                    // Upload to Supabase Storage
                    console.log(`[Stage3 Attachments] Uploading to storage...`);
                    const { data: uploadData, error: uploadError } = await supabaseClient
                        .storage
                        .from(STAGE3_ATTACHMENTS_BUCKET)
                        .upload(filePath, file, {
                            cacheControl: '3600',
                            upsert: false
                        });

                    if (uploadError) {
                        console.error(`[Stage3 Attachments] ❌ Upload error for ${file.name}:`, uploadError);
                        console.error(`[Stage3 Attachments] Error code: ${uploadError.statusCode || 'N/A'}`);
                        console.error(`[Stage3 Attachments] Error message: ${uploadError.message || 'N/A'}`);
                        errors.push(`Upload failed for ${file.name}: ${uploadError.message || 'Unknown error'}`);
                        failed++;
                        continue;
                    }

                    console.log(`[Stage3 Attachments] ✅ File uploaded successfully to storage`);
                    console.log(`[Stage3 Attachments] Upload data:`, uploadData);

                    // Get public URL
                    console.log(`[Stage3 Attachments] Getting public URL...`);
                    const { data: publicData } = supabaseClient
                        .storage
                        .from(STAGE3_ATTACHMENTS_BUCKET)
                        .getPublicUrl(filePath);

                    const fileUrl = publicData?.publicUrl || null;
                    console.log(`[Stage3 Attachments] Public URL: ${fileUrl}`);
                    
                    if (!fileUrl) {
                        console.warn(`[Stage3 Attachments] ⚠️ Warning: No public URL returned`);
                    }

                    // Insert metadata into database
                    const attachmentData = {
                        form_id: formId,
                        stage3_data_id: stage3DataId,
                        item_id: itemId,
                        filename: file.name,
                        file_type: file.type || null,
                        file_size: file.size || null,
                        file_url: fileUrl,
                        storage_path: filePath
                    };

                    console.log(`[Stage3 Attachments] Inserting metadata into database...`);
                    console.log(`[Stage3 Attachments] Attachment data:`, JSON.stringify(attachmentData, null, 2));

                    const { data: insertedData, error: insertError } = await supabaseClient
                        .from('ms_stage3_attachments')
                        .insert([attachmentData])
                        .select();

                    if (insertError) {
                        console.error(`[Stage3 Attachments] ❌ Error saving metadata for ${file.name}:`, insertError);
                        console.error(`[Stage3 Attachments] Error code: ${insertError.code || 'N/A'}`);
                        console.error(`[Stage3 Attachments] Error message: ${insertError.message || 'N/A'}`);
                        console.error(`[Stage3 Attachments] Error details:`, insertError);
                        errors.push(`Database insert failed for ${file.name}: ${insertError.message || 'Unknown error'}`);
                        failed++;
                    } else {
                        console.log(`[Stage3 Attachments] ✅ Metadata saved successfully to database`);
                        console.log(`[Stage3 Attachments] Inserted data:`, insertedData);
                        uploaded++;
                    }
                } catch (error) {
                    console.error(`[Stage3 Attachments] ❌ Unexpected error for ${file.name}:`, error);
                    console.error(`[Stage3 Attachments] Error stack:`, error.stack);
                    errors.push(`Unexpected error for ${file.name}: ${error.message || 'Unknown error'}`);
                    failed++;
                }
            }

            console.log(`[Stage3 Attachments] ========== Upload complete ==========`);
            console.log(`[Stage3 Attachments] Total uploaded: ${uploaded}`);
            console.log(`[Stage3 Attachments] Total failed: ${failed}`);
            if (errors.length > 0) {
                console.error(`[Stage3 Attachments] Errors:`, errors);
            }

            return { uploaded, failed, errors };
        }

        let formId = null;
        let requestData = null;
        let items = [];

        // Get form ID from URL
        function getFormIdFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('id');
        }

        // Check authentication
        async function checkAuth() {
            const user = await getCurrentUser();
            if (!user) {
                window.location.href = 'login.html';
                return false;
            }
            const role = user.role || 'user';
            if (role !== 'technical' && role !== 'manager' && role !== 'admin') {
                alert('You do not have permission to access this page.');
                window.location.href = 'dashboard.html';
                return false;
            }
            return true;
        }

        // Load request data
        async function loadRequestData() {
            formId = getFormIdFromURL();
            if (!formId) {
                showAlert('No request ID provided', 'danger');
                return;
            }

            const { data, error } = await supabaseClient
                .from('ms_forms')
                .select('*, ms_form_items(*)')
                .eq('id', formId)
                .single();

            if (error) {
                console.error('Error loading request:', error);
                showAlert('Error loading request: ' + error.message, 'danger');
                return;
            }

            if (data.status !== 'approved_review') {
                showAlert('This request is not approved for stage 3 data entry', 'danger');
                setTimeout(() => window.location.href = 'review.html', 2000);
                return;
            }

            requestData = data;
            items = data.ms_form_items || [];
            displayRequestInfo();
            displayItemsForm();
        }

        // Display request info
        function displayRequestInfo() {
            const requestInfo = document.getElementById('requestInfo');
            requestInfo.innerHTML = `
                <div class="request-info">
                    <h3 style="margin-bottom: 16px; color: var(--primary);">Request Information</h3>
                    <div class="info-row">
                        <span class="info-label">Request ID:</span>
                        <span class="info-value">#${requestData.id}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Requester:</span>
                        <span class="info-value">${requestData.name}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Email:</span>
                        <span class="info-value">${requestData.email}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Department:</span>
                        <span class="info-value">${requestData.department}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Location:</span>
                        <span class="info-value">${requestData.location}</span>
                    </div>
                </div>
            `;
        }

        // Display items form
        function displayItemsForm() {
            const container = document.getElementById('itemsContainer');
            container.innerHTML = '';

            items.forEach((item, index) => {
                const itemForm = document.createElement('div');
                itemForm.className = 'item-card';
                itemForm.innerHTML = `
                    <div class="item-header">Item ${index + 1}: ${item.waste_name}</div>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">WAP Number</label>
                            <input type="text" class="form-input" name="wap_${item.id}" placeholder="Enter WAP number">
                        </div>
                        <div class="form-group">
                            <label class="form-label required">Hazardous Classification</label>
                            <select class="form-select" name="hazardous_${item.id}" required>
                                <option value="">Select</option>
                                <option value="Hazardous">Hazardous</option>
                                <option value="Non-Hazardous">Non-Hazardous</option>
                            </select>
                        </div>
                    </div>

                    <div class="section-title">Treatment Codes</div>
                    <div class="checkbox-group" id="treatment_${item.id}">
                        <div class="checkbox-item"><input type="checkbox" name="treatment_${item.id}" value="T-01" id="t1_${item.id}"><label for="t1_${item.id}">T-01</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="treatment_${item.id}" value="T-02" id="t2_${item.id}"><label for="t2_${item.id}">T-02</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="treatment_${item.id}" value="T-03" id="t3_${item.id}"><label for="t3_${item.id}">T-03</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="treatment_${item.id}" value="T-04" id="t4_${item.id}"><label for="t4_${item.id}">T-04</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="treatment_${item.id}" value="T-05" id="t5_${item.id}"><label for="t5_${item.id}">T-05</label></div>
                    </div>

                    <div class="section-title">Disposal Codes</div>
                    <div class="checkbox-group" id="discharge_${item.id}">
                        <div class="checkbox-item"><input type="checkbox" name="discharge_${item.id}" value="D-01" id="d1_${item.id}"><label for="d1_${item.id}">D-01</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="discharge_${item.id}" value="D-02" id="d2_${item.id}"><label for="d2_${item.id}">D-02</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="discharge_${item.id}" value="D-03" id="d3_${item.id}"><label for="d3_${item.id}">D-03</label></div>
                    </div>

                    <div class="section-title">Recycle Codes</div>
                    <div class="checkbox-group" id="recycle_${item.id}">
                        <div class="checkbox-item"><input type="checkbox" name="recycle_${item.id}" value="R-01" id="r1_${item.id}"><label for="r1_${item.id}">R-01</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="recycle_${item.id}" value="R-02" id="r2_${item.id}"><label for="r2_${item.id}">R-02</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="recycle_${item.id}" value="R-03" id="r3_${item.id}"><label for="r3_${item.id}">R-03</label></div>
                    </div>

                    <div class="section-title">Recycle Codes (Materials)</div>
                    <div class="checkbox-group" id="recovered_${item.id}">
                        <div class="checkbox-item"><input type="checkbox" name="recovered_${item.id}" value="Oil/Solvent" id="rm1_${item.id}"><label for="rm1_${item.id}">Oil/Solvent</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="recovered_${item.id}" value="Acid" id="rm2_${item.id}"><label for="rm2_${item.id}">Acid</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="recovered_${item.id}" value="Batteries" id="rm3_${item.id}"><label for="rm3_${item.id}">Batteries</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="recovered_${item.id}" value="Metal" id="rm4_${item.id}"><label for="rm4_${item.id}">Metal</label></div>
                        <div class="checkbox-item"><input type="checkbox" name="recovered_${item.id}" value="Other" id="rm5_${item.id}"><label for="rm5_${item.id}">Other</label></div>
                    </div>

                    <div class="section-title">Percentage Distribution</div>
                    <div class="percent-grid">
                        <div class="percent-input">
                            <label class="form-label">Oil %</label>
                            <input type="number" class="form-input" name="oil_${item.id}" min="0" max="100" step="0.01" placeholder="0.00">
                        </div>
                        <div class="percent-input">
                            <label class="form-label">Water %</label>
                            <input type="number" class="form-input" name="water_${item.id}" min="0" max="100" step="0.01" placeholder="0.00">
                        </div>
                        <div class="percent-input">
                            <label class="form-label">Sludge %</label>
                            <input type="number" class="form-input" name="sludge_${item.id}" min="0" max="100" step="0.01" placeholder="0.00">
                        </div>
                        <div class="percent-input">
                            <label class="form-label">Solvent %</label>
                            <input type="number" class="form-input" name="solvent_${item.id}" min="0" max="100" step="0.01" placeholder="0.00">
                        </div>
                        <div class="percent-input">
                            <label class="form-label">Recovery %</label>
                            <input type="number" class="form-input" name="recovery_${item.id}" min="0" max="100" step="0.01" placeholder="0.00">
                        </div>
                        <div class="percent-input">
                            <label class="form-label">Landfill %</label>
                            <input type="number" class="form-input" name="landfill_${item.id}" min="0" max="100" step="0.01" placeholder="0.00">
                        </div>
                        <div class="percent-input">
                            <label class="form-label">Evaporation Pond %</label>
                            <input type="number" class="form-input" name="evaporation_${item.id}" min="0" max="100" step="0.01" placeholder="0.00">
                        </div>
                    </div>

                    <div class="section-title" style="margin-top: 24px;">Stage 3 Attachments</div>
                    <div class="form-group">
                        <label class="form-label">Upload attachments for this item (optional)</label>
                        <input type="file" class="form-input" name="stage3_attachments_${item.id}" id="stage3_attachments_${item.id}" multiple accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                        <div style="font-size: 12px; color: #6b7280; margin-top: 6px;">
                            Supported: PDF, Images, Excel, Word documents
                        </div>
                        <div id="stage3_attachments_preview_${item.id}" style="margin-top: 12px;"></div>
                    </div>
                `;
                container.appendChild(itemForm);

                // Preview attachments
                const attachmentsInput = document.getElementById(`stage3_attachments_${item.id}`);
                const previewDiv = document.getElementById(`stage3_attachments_preview_${item.id}`);
                attachmentsInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files.length > 0) {
                        previewDiv.innerHTML = `<div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">`;
                        Array.from(files).forEach((file, idx) => {
                            previewDiv.innerHTML += `
                                <span style="background: #e0f2fe; color: #0369a1; padding: 6px 12px; border-radius: 8px; font-size: 12px; display: inline-flex; align-items: center; gap: 6px;">
                                    <i class="fas fa-file"></i> ${file.name}
                                </span>
                            `;
                        });
                        previewDiv.innerHTML += `</div>`;
                    } else {
                        previewDiv.innerHTML = '';
                    }
                });
            });
        }

        // Handle form submission
        document.getElementById('stage3Form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitBtn');
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                const { data: { user } } = await supabaseClient.auth.getUser();
                if (!user) {
                    throw new Error('User not authenticated');
                }

                // Collect data for each item
                const stage3DataArray = [];
                items.forEach(item => {
                    const formData = new FormData(e.target);
                    const treatmentCodes = Array.from(document.querySelectorAll(`input[name="treatment_${item.id}"]:checked`)).map(cb => cb.value);
                    const dischargeCodes = Array.from(document.querySelectorAll(`input[name="discharge_${item.id}"]:checked`)).map(cb => cb.value);
                    const recycleCodes = Array.from(document.querySelectorAll(`input[name="recycle_${item.id}"]:checked`)).map(cb => cb.value);
                    const recoveredMaterials = Array.from(document.querySelectorAll(`input[name="recovered_${item.id}"]:checked`)).map(cb => cb.value);

                    stage3DataArray.push({
                        form_id: formId,
                        item_id: item.id,
                        wap_number: formData.get(`wap_${item.id}`) || null,
                        hazardous_classification: formData.get(`hazardous_${item.id}`) || null,
                        treatment_codes: treatmentCodes.length > 0 ? treatmentCodes : null,
                        discharge_codes: dischargeCodes.length > 0 ? dischargeCodes : null,
                        recycle_codes: recycleCodes.length > 0 ? recycleCodes : null,
                        recovered_materials: recoveredMaterials.length > 0 ? recoveredMaterials : null,
                        oil_percent: parseFloat(formData.get(`oil_${item.id}`)) || null,
                        water_percent: parseFloat(formData.get(`water_${item.id}`)) || null,
                        sludge_percent: parseFloat(formData.get(`sludge_${item.id}`)) || null,
                        solvent_percent: parseFloat(formData.get(`solvent_${item.id}`)) || null,
                        recovery_percent: parseFloat(formData.get(`recovery_${item.id}`)) || null,
                        landfill_percent: parseFloat(formData.get(`landfill_${item.id}`)) || null,
                        evaporation_pond_percent: parseFloat(formData.get(`evaporation_${item.id}`)) || null,
                        filled_by: user.id,
                        filled_at: new Date().toISOString()
                    });
                });

                // Insert stage3 data
                const { data: insertedStage3, error: stage3Error } = await supabaseClient
                    .from('ms_stage3_data')
                    .insert(stage3DataArray)
                    .select();

                if (stage3Error) {
                    throw stage3Error;
                }

                // Upload Stage 3 attachments for each item
                if (insertedStage3 && insertedStage3.length > 0) {
                    console.log(`[Stage3] ========== Starting attachments upload ==========`);
                    console.log(`[Stage3] Items count: ${items.length}`);
                    let totalUploaded = 0;
                    let totalFailed = 0;
                    const allErrors = [];

                    for (let i = 0; i < items.length; i++) {
                        const item = items[i];
                        const stage3Record = insertedStage3[i];
                        const attachmentsInput = document.getElementById(`stage3_attachments_${item.id}`);
                        
                        console.log(`[Stage3] Processing item ${i + 1}/${items.length} (Item ID: ${item.id})`);
                        console.log(`[Stage3] Stage3 Record ID: ${stage3Record.id}`);
                        console.log(`[Stage3] Attachments input found: ${!!attachmentsInput}`);
                        
                        if (attachmentsInput && attachmentsInput.files.length > 0) {
                            console.log(`[Stage3] Found ${attachmentsInput.files.length} file(s) for item ${item.id}`);
                            const result = await uploadStage3Attachments(formId, stage3Record.id, item.id, attachmentsInput.files);
                            totalUploaded += result.uploaded;
                            totalFailed += result.failed;
                            if (result.errors && result.errors.length > 0) {
                                allErrors.push(...result.errors);
                            }
                        } else {
                            console.log(`[Stage3] No attachments for item ${item.id}`);
                        }
                    }

                    console.log(`[Stage3] ========== All attachments processed ==========`);
                    console.log(`[Stage3] Total uploaded: ${totalUploaded}`);
                    console.log(`[Stage3] Total failed: ${totalFailed}`);
                    
                    if (totalUploaded > 0) {
                        showAlert(`${totalUploaded} attachment(s) uploaded successfully${totalFailed > 0 ? `. ${totalFailed} failed. Check console for details.` : '.'}`, 'success');
                    } else if (totalFailed > 0) {
                        const errorMsg = `Failed to upload ${totalFailed} attachment(s). ${allErrors.length > 0 ? 'Errors: ' + allErrors.join('; ') : 'Check console for details.'}`;
                        showAlert(errorMsg, 'danger');
                        console.error(`[Stage3] All errors:`, allErrors);
                    } else {
                        console.log(`[Stage3] No attachments were provided`);
                    }
                } else {
                    console.warn(`[Stage3] No Stage 3 data inserted, skipping attachments upload`);
                }

                // Update form status to pending_manager_approval
                const { error: updateError } = await supabaseClient
                    .from('ms_forms')
                    .update({
                        status: 'pending_manager_approval',
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', formId);

                if (updateError) {
                    throw updateError;
                }

                // Verify attachments were saved
                let verifyMessage = 'Stage 3 data submitted successfully! Request sent to manager for approval.';
                if (insertedStage3 && insertedStage3.length > 0) {
                    console.log(`[Stage3] Verifying attachments were saved...`);
                    const { data: verifyAttachments, error: verifyError } = await supabaseClient
                        .from('ms_stage3_attachments')
                        .select('id, filename, file_url, item_id')
                        .eq('form_id', formId);
                    
                    if (verifyError) {
                        console.error(`[Stage3] Error verifying attachments:`, verifyError);
                    } else {
                        console.log(`[Stage3] Verified attachments:`, verifyAttachments);
                        if (verifyAttachments && verifyAttachments.length > 0) {
                            verifyMessage += ` ${verifyAttachments.length} attachment(s) saved.`;
                            console.log(`[Stage3] ✅ Verification successful: ${verifyAttachments.length} attachment(s) found in database`);
                        } else {
                            console.warn(`[Stage3] ⚠️ Verification: No attachments found in database for form ${formId}`);
                        }
                    }
                }

                showAlert(verifyMessage, 'success');
                setTimeout(() => {
                    window.location.href = 'review.html';
                }, 2000);

            } catch (error) {
                console.error('Submit error:', error);
                showAlert('Error submitting data: ' + error.message, 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit for Manager Approval';
            }
        });

        // Show alert
        function showAlert(message, type = 'danger') {
            const container = document.getElementById('alertContainer');
            container.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                </div>
            `;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        // Initialize
        (async () => {
            if (await checkAuth()) {
                await loadRequestData();
            }
        })();
    </script>
</body>
</html>

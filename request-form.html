<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reviva - MS Form</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: #f5f5f5;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #3d9b7c;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header img {
            width: 60px;
            height: auto;
        }

        .logout-btn {
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logout-btn:hover {
            background: #b91c1c;
        }

        .form-card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section-title {
            color: #3d9b7c;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .required::after {
            content: " *";
            color: #dc2626;
        }

        .form-input,
        .form-select {
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
            width: 100%;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: #3d9b7c;
            box-shadow: 0 0 0 3px rgba(61, 155, 124, 0.1);
        }

        .items-section {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: #3d9b7c;
            color: white;
        }

        .btn-primary:hover {
            background: #2d7a5f;
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .items-list {
            margin-top: 20px;
        }

        .item-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-details {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .item-field {
            display: flex;
            flex-direction: column;
        }

        .item-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .item-value {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
        }

        .btn-delete {
            background: #fee2e2;
            color: #dc2626;
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-delete:hover {
            background: #fecaca;
        }

        .form-footer {
            display: flex;
            justify-content: flex-end;
            gap: 16px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        .alert {
            padding: 14px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #dc2626;
        }

        .hidden {
            display: none !important;
        }

        .success-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .success-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 100%;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
        }

        .success-icon {
            width: 80px;
            height: 80px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
        }

        .success-icon i {
            font-size: 40px;
            color: white;
        }

        .success-title {
            color: #3d9b7c;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .success-message {
            color: #6b7280;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; gap: 12px;">
                <img src="Logo.png" alt="Reviva Logo" style="width: 60px; height: auto;">
                <h1>M.S Form</h1>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <a href="dashboard.html" style="padding: 10px 20px; background: linear-gradient(135deg, #66a286, #63a597); color: white; border-radius: 8px; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px; font-weight: 500; box-shadow: 0 4px 12px rgba(102, 162, 134, 0.3); transition: all 0.3s ease;">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="review.html" style="padding: 10px 20px; background: #3d9b7c; color: white; border-radius: 8px; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px; font-weight: 500;">
                    <i class="fas fa-clipboard-check"></i> Review Requests
                </a>
                <button class="logout-btn" id="logoutBtn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>

        <div class="form-card">
            <div id="alertContainer"></div>

            <!-- General Information -->
            <h2 class="section-title">General Information</h2>
            <div class="form-grid">
                <div class="form-group">
                    <label for="name" class="form-label required">Full Name</label>
                    <input type="text" id="name" class="form-input" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="email" class="form-label required">Email Address</label>
                    <input type="email" id="email" class="form-input" placeholder="your.email@example.com" required>
                </div>
                <div class="form-group">
                    <label for="department" class="form-label required">Department</label>
                    <select id="department" class="form-select" required>
                        <option value="">Select Department</option>
                        <option value="Marketing">Marketing</option>
                        <option value="Environment">Environment</option>
                        <option value="Operation">Operation</option>
                        <option value="by product">by product</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="location" class="form-label required">Location</label>
                    <select id="location" class="form-select" required>
                        <option value="">Select Location</option>
                        <option value="Jubail">Jubail</option>
                        <option value="Dammam">Dammam</option>
                        <option value="Yanbu">Yanbu</option>
                        <option value="Rabigh">Rabigh</option>
                        <option value="Johfah">Johfah</option>
                        <option value="Jizan">Jizan</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description" class="form-label">Description</label>
                    <input type="text" id="description" class="form-input" placeholder="Optional description">
                </div>
            </div>

            <!-- Add Waste Items -->
            <div class="items-section">
                <h2 class="section-title">Add Waste Items</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="wasteName" class="form-label required">Waste Name</label>
                        <input type="text" id="wasteName" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="wasteDescription" class="form-label">Waste Description</label>
                        <input type="text" id="wasteDescription" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="physicalState" class="form-label required">Physical State</label>
                        <select id="physicalState" class="form-select" required>
                            <option value="">Select State</option>
                            <option value="Liquid">Liquid</option>
                            <option value="Solid">Solid</option>
                            <option value="Sludge">Sludge</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="quantity" class="form-label required">Quantity</label>
                        <input type="number" id="quantity" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label for="quantityUnit" class="form-label">Quantity Unit</label>
                        <select id="quantityUnit" class="form-select">
                            <option value="">Select Unit</option>
                            <option value="Ton">Ton</option>
                            <option value="Cubic meter">Cubic meter</option>
                            <option value="Kg">Kg</option>
                            <option value="Liter">Liter</option>
                            <option value="Piece">Piece</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="packingType" class="form-label">Packing Type</label>
                        <select id="packingType" class="form-select">
                            <option value="">Select Type</option>
                            <option value="ISO Tank">ISO Tank</option>
                            <option value="IBC">IBC</option>
                            <option value="Drum">Drum</option>
                            <option value="Jubo bag">Jubo bag</option>
                            <option value="Gallon">Gallon</option>
                            <option value="Other">Other</option>
                            <option value="Non">Non</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="truckType" class="form-label">Truck Type</label>
                        <select id="truckType" class="form-select">
                            <option value="">Select Truck</option>
                            <option value="Water Truck">Water Truck</option>
                            <option value="Vacuum Truck">Vacuum Truck</option>
                            <option value="Super sucker">Super sucker</option>
                            <option value="Skip Truck">Skip Truck</option>
                            <option value="Road Tanker">Road Tanker</option>
                            <option value="Flatbed">Flatbed</option>
                            <option value="Dump Truck">Dump Truck</option>
                            <option value="Acid Tanker">Acid Tanker</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="supportingDocument" class="form-label">Supporting Document</label>
                        <input type="file" id="supportingDocument" class="form-input">
                    </div>
                </div>
                <button id="addItemBtn" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Add Item
                </button>
            </div>

            <!-- Items List -->
            <div id="itemsListSection" class="hidden">
                <h2 class="section-title">Added Items (<span id="itemsCount">0</span>)</h2>
                <div id="itemsList" class="items-list"></div>
            </div>

            <!-- Submit Button -->
            <div class="form-footer">
                <button id="submitBtn" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Submit for Processing
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="successModal" class="success-modal hidden">
        <div class="success-card">
            <div class="success-icon">
                <i class="fas fa-check"></i>
            </div>
            <h2 class="success-title">Submission Successful!</h2>
            <p class="success-message">Your waste management request has been submitted for processing.</p>
        </div>
    </div>

    <script>
        // Initialize Supabase client
        const supabaseClient = window.supabaseClient || (() => {
            if (typeof CONFIG !== 'undefined' && typeof supabase !== 'undefined') {
                return supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_ANON_KEY);
            }
            console.error('Supabase client not available');
            return null;
        })();

        // Application state
        const state = {
            formData: {
                name: '',
                email: '',
                department: '',
                location: '',
                description: ''
            },
            items: [],
            currentItem: {
                wasteName: '',
                wasteDescription: '',
                physicalState: '',
                quantity: '',
                quantityUnit: '',
                packingType: '',
                truckType: '',
                supportingDocument: null
            }
        };

        function generateId() {
            if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
            return 'id-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        }

        // DOM Elements
        const alertContainer = document.getElementById('alertContainer');
        const itemsListSection = document.getElementById('itemsListSection');
        const itemsList = document.getElementById('itemsList');
        const itemsCount = document.getElementById('itemsCount');
        const successModal = document.getElementById('successModal');
        const logoutBtn = document.getElementById('logoutBtn');

        // Form inputs
        const nameInput = document.getElementById('name');
        const emailInput = document.getElementById('email');
        const departmentSelect = document.getElementById('department');
        const locationSelect = document.getElementById('location');
        const descriptionInput = document.getElementById('description');

        // Item inputs
        const wasteNameInput = document.getElementById('wasteName');
        const wasteDescriptionInput = document.getElementById('wasteDescription');
        const physicalStateSelect = document.getElementById('physicalState');
        const quantityInput = document.getElementById('quantity');
        const quantityUnitSelect = document.getElementById('quantityUnit');
        const packingTypeSelect = document.getElementById('packingType');
        const truckTypeSelect = document.getElementById('truckType');
        const supportingDocumentInput = document.getElementById('supportingDocument');

        // Buttons
        const addItemBtn = document.getElementById('addItemBtn');
        const submitBtn = document.getElementById('submitBtn');

        // Show alert
        function showAlert(message, type = 'error') {
            alertContainer.innerHTML = `
                <div class="alert alert-${type}">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                    ${message}
                </div>
            `;
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        // Update form data
        function updateFormData(field, value) {
            state.formData[field] = value;
        }

        // Update current item
        function updateCurrentItem(field, value) {
            state.currentItem[field] = value;
        }

        // Add item
        function addItem() {
            if (!state.currentItem.wasteName || !state.currentItem.physicalState || !state.currentItem.quantity) {
                showAlert('Please fill in required fields: Waste Name, Physical State, and Quantity');
                return;
            }

            const newItem = {
                ...state.currentItem,
                id: Date.now()
            };

            console.log('[Add Item] Adding item:', {
                wasteName: newItem.wasteName,
                hasDocument: !!newItem.supportingDocument,
                fileName: newItem.supportingDocument?.name,
                fileSize: newItem.supportingDocument?.size
            });

            state.items.push(newItem);
            resetCurrentItem();
            updateItemsList();
            itemsListSection.classList.remove('hidden');
            
            console.log('[Add Item] Total items in state:', state.items.length);
            console.log('[Add Item] Items with attachments:', state.items.filter(i => i.supportingDocument).length);
        }

        // Remove item
        function removeItem(id) {
            state.items = state.items.filter(item => item.id !== id);
            updateItemsList();
            if (state.items.length === 0) {
                itemsListSection.classList.add('hidden');
            }
        }

        // Reset current item
        function resetCurrentItem() {
            state.currentItem = {
                wasteName: '',
                wasteDescription: '',
                physicalState: '',
                quantity: '',
                quantityUnit: '',
                packingType: '',
                truckType: '',
                supportingDocument: null
            };

            wasteNameInput.value = '';
            wasteDescriptionInput.value = '';
            physicalStateSelect.value = '';
            quantityInput.value = '';
            quantityUnitSelect.value = '';
            packingTypeSelect.value = '';
            truckTypeSelect.value = '';
            supportingDocumentInput.value = '';
        }

        // Update items list
        function updateItemsList() {
            itemsCount.textContent = state.items.length;
            itemsList.innerHTML = '';

            state.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'item-card';
                itemElement.innerHTML = `
                    <div class="item-details">
                        <div class="item-field">
                            <span class="item-label">Name:</span>
                            <span class="item-value">${item.wasteName}</span>
                        </div>
                        <div class="item-field">
                            <span class="item-label">Description:</span>
                            <span class="item-value">${item.wasteDescription || 'N/A'}</span>
                        </div>
                        <div class="item-field">
                            <span class="item-label">State:</span>
                            <span class="item-value">${item.physicalState}</span>
                        </div>
                        <div class="item-field">
                            <span class="item-label">Quantity:</span>
                            <span class="item-value">${item.quantity} ${item.quantityUnit || ''}</span>
                        </div>
                        <div class="item-field">
                            <span class="item-label">Packing:</span>
                            <span class="item-value">${item.packingType || 'N/A'}</span>
                        </div>
                        <div class="item-field">
                            <span class="item-label">Truck Type:</span>
                            <span class="item-value">${item.truckType || 'N/A'}</span>
                        </div>
                        ${item.supportingDocument ? `
                        <div class="item-field" style="grid-column: 1 / -1;">
                            <span class="item-label">Attachment:</span>
                            <span class="item-value" style="color: #3d9b7c; font-weight: 600;">
                                <i class="fas fa-paperclip"></i> ${item.supportingDocument.name} (${(item.supportingDocument.size / 1024).toFixed(2)} KB)
                            </span>
                        </div>
                        ` : ''}
                    </div>
                    <button class="btn-delete" onclick="removeItem(${item.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                `;
                itemsList.appendChild(itemElement);
            });
        }

        // Upload attachment to Supabase Storage
        // All attachments (form and stage3) are stored in the same bucket but in separate folders:
        // - Form attachments: form/form-{formId}/item-{itemId}/{filename}
        // - Stage3 attachments: stage3/form-{formId}/item-{itemId}/{filename}
        const ATTACHMENTS_BUCKET = 'ms_attachments';
        
        async function uploadAttachment(file, formId, itemId = null) {
            if (!file) {
                console.warn('[Upload] No file provided');
                return null;
            }
            
            try {
                console.log(`[Upload] ========== Starting upload ==========`);
                console.log(`[Upload] File: ${file.name}`);
                console.log(`[Upload] Size: ${(file.size / 1024).toFixed(2)} KB`);
                console.log(`[Upload] Type: ${file.type || 'unknown'}`);
                console.log(`[Upload] Form ID: ${formId}`);
                console.log(`[Upload] Item ID: ${itemId || 'N/A'}`);
                console.log(`[Upload] Bucket: ${ATTACHMENTS_BUCKET}`);
                
                // Generate unique file path
                // Structure: form/form-{formId}/item-{itemId}/{timestamp}-{filename}
                const fileExt = file.name.split('.').pop();
                const timestamp = Date.now();
                const randomStr = Math.random().toString(36).substring(7);
                const safeFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const fileName = `${timestamp}-${randomStr}-${safeFileName}`;
                
                // Create separate folder structure for form attachments (not stage3)
                const filePath = itemId 
                    ? `form/form-${formId}/item-${itemId}/${fileName}`
                    : `form/form-${formId}/${fileName}`;
                
                console.log(`[Upload] Uploading file: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);
                console.log(`[Upload] Storage path: ${filePath}`);
                
                // Upload to storage
                console.log(`[Upload] Attempting to upload to: ${ATTACHMENTS_BUCKET}/${filePath}`);
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from(ATTACHMENTS_BUCKET)
                    .upload(filePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (uploadError) {
                    console.error('[Upload] ❌ Storage upload error:', uploadError);
                    console.error('[Upload] Error code:', uploadError.statusCode);
                    console.error('[Upload] Error message:', uploadError.message);
                    
                    // Provide more specific error messages
                    if (uploadError.message?.includes('Bucket not found') || uploadError.message?.includes('does not exist')) {
                        const errorMsg = `Storage bucket '${ATTACHMENTS_BUCKET}' not found. Please create it in Supabase Storage and make it PUBLIC.`;
                        console.error(`[Upload] ${errorMsg}`);
                        throw new Error(errorMsg);
                    } else if (uploadError.message?.includes('new row violates row-level security')) {
                        const errorMsg = `Permission denied. Please check Storage policies for bucket '${ATTACHMENTS_BUCKET}'.`;
                        console.error(`[Upload] ${errorMsg}`);
                        throw new Error(errorMsg);
                    } else {
                        throw uploadError;
                    }
                }
                
                console.log('[Upload] ✅ File uploaded to storage successfully');
                console.log('[Upload] Upload data:', uploadData);
                
                // Get public URL
                const { data: urlData } = supabaseClient.storage
                    .from(ATTACHMENTS_BUCKET)
                    .getPublicUrl(filePath);
                
                const fileUrl = urlData?.publicUrl || '';
                if (!fileUrl) {
                    console.warn('[Upload] ⚠️ Warning: No public URL returned');
                    console.warn('[Upload] URL Data:', urlData);
                } else {
                    console.log('[Upload] ✅ Public URL:', fileUrl);
                }
                
                // Get current user
                let userId = null;
                try {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (user) userId = user.id;
                } catch (e) {
                    // User not logged in - that's okay
                }
                
                // Insert attachment metadata
                console.log('[Upload] Preparing to save metadata to database...');
                const attachmentData = {
                    form_id: formId,
                    item_id: itemId,
                    filename: file.name,
                    file_name: file.name,
                    file_type: file.type || 'application/octet-stream',
                    file_size: file.size,
                    file_url: fileUrl,
                    storage_path: filePath,
                    uploaded_by: userId
                };
                
                console.log('[Upload] Attachment data:', JSON.stringify(attachmentData, null, 2));
                
                const { data: insertedData, error: insertError } = await supabaseClient
                    .from('ms_form_attachments')
                    .insert([attachmentData])
                    .select();
                
                if (insertError) {
                    console.error('[Upload] ❌ Database insert error:', insertError);
                    console.error('[Upload] Error code:', insertError.code);
                    console.error('[Upload] Error message:', insertError.message);
                    console.error('[Upload] Error details:', insertError);
                    
                    // Check if table doesn't exist
                    if (insertError.message?.includes('relation') || insertError.message?.includes('does not exist') || insertError.code === '42P01') {
                        const errorMsg = 'Table ms_form_attachments does not exist! Please run setup_form_attachments.sql in Supabase SQL Editor.';
                        console.error(`[Upload] ${errorMsg}`);
                        // Try to delete uploaded file if database insert fails
                        try {
                            await supabaseClient.storage.from(ATTACHMENTS_BUCKET).remove([filePath]);
                            console.log('[Upload] Cleaned up uploaded file after database error');
                        } catch (cleanupError) {
                            console.error('[Upload] Error cleaning up file:', cleanupError);
                        }
                        throw new Error(errorMsg);
                    }
                    
                    // Check for permission errors
                    if (insertError.code === '42501' || insertError.message?.includes('permission') || insertError.message?.includes('row-level security')) {
                        const errorMsg = 'Permission denied. Please check RLS policies for ms_form_attachments table.';
                        console.error(`[Upload] ${errorMsg}`);
                        // Try to delete uploaded file if database insert fails
                        try {
                            await supabaseClient.storage.from(ATTACHMENTS_BUCKET).remove([filePath]);
                            console.log('[Upload] Cleaned up uploaded file after database error');
                        } catch (cleanupError) {
                            console.error('[Upload] Error cleaning up file:', cleanupError);
                        }
                        throw new Error(errorMsg);
                    }
                    
                    // Try to delete uploaded file if database insert fails
                    try {
                        await supabaseClient.storage.from(ATTACHMENTS_BUCKET).remove([filePath]);
                        console.log('[Upload] Cleaned up uploaded file after database error');
                    } catch (cleanupError) {
                        console.error('[Upload] Error cleaning up file:', cleanupError);
                    }
                    throw insertError;
                }
                
                console.log('[Upload] ✅ Attachment metadata saved to database successfully');
                console.log('[Upload] Inserted data:', insertedData);
                console.log('[Upload] ========== Upload complete ==========');
                return insertedData[0];
                
            } catch (error) {
                console.error('[Upload] ❌ Error uploading attachment:', error);
                throw error;
            }
        }

        // Handle submit
        async function handleSubmit() {
            // Validate
            if (!state.formData.name || !state.formData.email || !state.formData.department || !state.formData.location) {
                showAlert('Please fill in all required fields (Name, Email, Department, Location)');
                return;
            }

            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(state.formData.email)) {
                showAlert('Please enter a valid email address');
                return;
            }

            if (state.items.length === 0) {
                showAlert('Please add at least one waste item');
                return;
            }

            if (!supabaseClient) {
                showAlert('Database connection error. Please refresh the page.');
                return;
            }

            // Debug: Check items and attachments before submit
            console.log('[Submit] ========== Starting form submission ==========');
            console.log('[Submit] Total items:', state.items.length);
            state.items.forEach((item, idx) => {
                console.log(`[Submit] Item ${idx + 1}:`, {
                    wasteName: item.wasteName,
                    hasDocument: !!item.supportingDocument,
                    fileName: item.supportingDocument?.name,
                    fileSize: item.supportingDocument?.size,
                    fileType: item.supportingDocument?.type
                });
            });

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

                // Get current user (optional)
                let userId = null;
                try {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (user) userId = user.id;
                } catch (e) {
                    // User not logged in - that's okay
                }

                // Insert form data
                const { data: formData, error: formError } = await supabaseClient
                    .from('ms_forms')
                    .insert([{
                        user_id: userId,
                        name: state.formData.name,
                        email: state.formData.email,
                        department: state.formData.department,
                        location: state.formData.location,
                        description: state.formData.description || null,
                        status: 'pending',
                        submitted_at: new Date().toISOString()
                    }])
                    .select();

                if (formError) {
                    console.error('Form error:', formError);
                    throw formError;
                }

                const formId = formData[0].id;
                console.log('[Submit] Form created with ID:', formId);

                // Insert items
                let insertedItems = [];
                if (state.items.length > 0) {
                    const itemsToInsert = state.items.map(item => ({
                        form_id: formId,
                        waste_name: item.wasteName,
                        waste_description: item.wasteDescription || null,
                        physical_state: item.physicalState,
                        quantity: parseFloat(item.quantity) || 0,
                        quantity_unit: item.quantityUnit || null,
                        packing_type: item.packingType || null,
                        truck_type: item.truckType || null,
                        supporting_document: null
                    }));

                    const { data: insertedItemsData, error: itemsError } = await supabaseClient
                        .from('ms_form_items')
                        .insert(itemsToInsert)
                        .select();

                    if (itemsError) {
                        console.error('Items error:', itemsError);
                        throw itemsError;
                    }
                    
                    insertedItems = insertedItemsData || [];
                    console.log('[Submit] Items inserted:', insertedItems.length);
                }

                // Upload attachments for each item
                let uploadedAttachments = 0;
                let attachmentErrors = [];
                
                console.log(`[Submit] ========== Starting attachments upload ==========`);
                console.log(`[Submit] Total items: ${state.items.length}`);
                console.log(`[Submit] Inserted items: ${insertedItems.length}`);
                
                for (let i = 0; i < state.items.length; i++) {
                    const item = state.items[i];
                    const insertedItem = insertedItems[i];
                    
                    console.log(`[Submit] Processing item ${i + 1}/${state.items.length}:`, {
                        itemId: insertedItem?.id,
                        hasDocument: !!item.supportingDocument,
                        fileName: item.supportingDocument?.name
                    });
                    
                    if (item.supportingDocument && insertedItem) {
                        try {
                            console.log(`[Submit] Uploading attachment for item ${insertedItem.id}: ${item.supportingDocument.name}`);
                            const result = await uploadAttachment(item.supportingDocument, formId, insertedItem.id);
                            if (result) {
                                uploadedAttachments++;
                                console.log(`[Submit] ✅ Attachment uploaded successfully for item ${insertedItem.id}`);
                            } else {
                                throw new Error('Upload function returned null');
                            }
                        } catch (attachError) {
                            console.error(`[Submit] ❌ Error uploading attachment for item ${insertedItem.id}:`, attachError);
                            attachmentErrors.push({
                                itemId: insertedItem.id,
                                fileName: item.supportingDocument.name,
                                error: attachError.message || attachError.toString() || 'Unknown error'
                            });
                            // Continue with other items even if one attachment fails
                        }
                    } else {
                        if (!item.supportingDocument) {
                            console.log(`[Submit] ⚠️ Item ${insertedItem?.id || i + 1} has no supporting document`);
                        }
                        if (!insertedItem) {
                            console.error(`[Submit] ❌ Item ${i + 1} was not inserted into database!`);
                        }
                    }
                }
                
                console.log(`[Submit] ========== Attachments upload complete ==========`);
                console.log(`[Submit] Successfully uploaded: ${uploadedAttachments}`);
                console.log(`[Submit] Failed: ${attachmentErrors.length}`);
                
                if (uploadedAttachments > 0) {
                    console.log(`[Submit] Successfully uploaded ${uploadedAttachments} attachment(s)`);
                }
                
                // Success
                let successMessage = 'Form submitted successfully!';
                if (uploadedAttachments > 0) {
                    successMessage += ` ${uploadedAttachments} attachment(s) uploaded.`;
                }
                
                if (attachmentErrors.length > 0) {
                    console.warn(`[Submit] ${attachmentErrors.length} attachment(s) failed to upload:`, attachmentErrors);
                    const errorDetails = attachmentErrors.map(e => `${e.fileName}: ${e.error}`).join('; ');
                    showAlert(`Form submitted successfully! However, ${attachmentErrors.length} attachment(s) failed to upload. Check console for details. Error: ${errorDetails.substring(0, 100)}...`, 'error');
                } else {
                    showAlert(successMessage, 'success');
                }
                successModal.classList.remove('hidden');

                // Reset form after 3 seconds
                setTimeout(() => {
                    successModal.classList.add('hidden');
                    resetForm();
                }, 3000);

            } catch (error) {
                console.error('Submit error:', error);
                let errorMessage = 'Submission failed. ';
                
                if (error.code === '42501' || error.message?.includes('permission')) {
                    errorMessage += 'Permission denied. Please check Supabase permissions.';
                } else if (error.message) {
                    errorMessage += error.message;
                }

                showAlert(errorMessage);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit for Processing';
            }
        }

        // Reset form
        function resetForm() {
            state.formData = {
                name: '',
                email: '',
                department: '',
                location: '',
                description: ''
            };
            state.items = [];
            resetCurrentItem();

            nameInput.value = '';
            emailInput.value = '';
            departmentSelect.value = '';
            locationSelect.value = '';
            descriptionInput.value = '';

            itemsListSection.classList.add('hidden');
            itemsList.innerHTML = '';
            itemsCount.textContent = '0';

            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit for Processing';
        }

        // Event listeners
        nameInput.addEventListener('input', (e) => updateFormData('name', e.target.value));
        emailInput.addEventListener('input', (e) => updateFormData('email', e.target.value));
        departmentSelect.addEventListener('change', (e) => updateFormData('department', e.target.value));
        locationSelect.addEventListener('change', (e) => updateFormData('location', e.target.value));
        descriptionInput.addEventListener('input', (e) => updateFormData('description', e.target.value));

        wasteNameInput.addEventListener('input', (e) => updateCurrentItem('wasteName', e.target.value));
        wasteDescriptionInput.addEventListener('input', (e) => updateCurrentItem('wasteDescription', e.target.value));
        physicalStateSelect.addEventListener('change', (e) => updateCurrentItem('physicalState', e.target.value));
        quantityInput.addEventListener('input', (e) => updateCurrentItem('quantity', e.target.value));
        quantityUnitSelect.addEventListener('change', (e) => updateCurrentItem('quantityUnit', e.target.value));
        packingTypeSelect.addEventListener('change', (e) => updateCurrentItem('packingType', e.target.value));
        truckTypeSelect.addEventListener('change', (e) => updateCurrentItem('truckType', e.target.value));
        supportingDocumentInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                console.log('[Form] File selected:', file.name, `(${(file.size / 1024).toFixed(2)} KB)`);
                updateCurrentItem('supportingDocument', file);
            } else {
                console.log('[Form] No file selected');
                updateCurrentItem('supportingDocument', null);
            }
        });

        addItemBtn.addEventListener('click', addItem);
        submitBtn.addEventListener('click', handleSubmit);

        // Logout button
        if (logoutBtn) {
            logoutBtn.addEventListener('click', async () => {
                if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
                window.location.href = 'login.html';
            });
        }

        // Check if user is logged in
        async function checkAuth() {
            if (!supabaseClient) return;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session && session.user && logoutBtn) {
                    logoutBtn.style.display = 'flex';
                }
            } catch (e) {
                // Not logged in - that's okay
            }
        }

        // Make removeItem available globally
        window.removeItem = removeItem;

        // Initialize
        checkAuth();
    </script>
</body>
</html>
